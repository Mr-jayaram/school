<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management - Expenses</title>
    <link rel="shortcut icon" href="https://jaiinfo.tech/logo/logo_only.png">
    <!-- Bootstrap CSS -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (Example: Poppins for a similar look) -->
    <link href="assets/css/css2.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Link to your external style.css file -->
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- Link to your expenses.css file (after style.css to allow overrides) -->
    <link rel="stylesheet" href="assets/css/expenses.css">

</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
           <div class="logo">
                <a href="index.html">
                   <img src="https://jaiinfo.tech/logo/logo_only.png" class="sidebar-icon" alt="Logo">
                   <span>Admin</span>
                </a>
            </div>
            <nav class="menu">
                <a href="index.html" class="menu-item">
                    <i class="bi bi-speedometer2 menu-icon"></i> <span>Dashboard</span>
                </a>

                <a href="javascript:void(0);" class="menu-item menu-item-toggle has-submenu">
                   <i class="bi bi-person-badge menu-icon"></i> <span>Add Member</span> <span class="arrow-icon">&#9660;</span>
                </a>
                <div class="submenu">
                    <a href="staff.html" class="submenu-item">Staffs</a>
                    <a href="student.html" class="submenu-item">Students</a>
                </div>

                <a href="attendance.html" class="menu-item">
                    <i class="bi bi-calendar-check menu-icon"></i> <span>Attendance</span>
                </a>
              

                <a href="fees.html" class="menu-item">
                    <i class="bi bi-wallet-fill menu-icon"></i> <span>Fees</span>
                </a>

               <a href="expenses.html" class="menu-item active"> 
                    <i class="bi bi-cash-coin menu-icon"></i> <span>Expenses</span>
                </a>
                  <a href="javascript:void(0);" class="menu-item menu-item-toggle has-submenu">
                    <i class="bi bi-graph-up-arrow menu-icon"></i> <span>Reports</span> <span class="arrow-icon">&#9660;</span>
                </a>
                <div class="submenu">
                    <a href="report.html" class="submenu-item">Student Reports</a>
                    <a href="report.html" class="submenu-item">Staff Reports</a>
                    <a href="report.html" class="submenu-item">Attendance Reports</a>
                </div> 
                <a href="annoncement.html" class="menu-item">
                    <i class="bi bi-chat-dots menu-icon"></i> <span>Announcements</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="bi bi-gear menu-icon"></i> <span>Settings</span>
                </a>
                   
                <a href="javascript:void(0);" class="menu-item menu-item-toggle has-submenu">
                  <i class="bi bi-shield-lock menu-icon"></i> <span>Auth</span>
                  <span class="arrow-icon">&#9660;</span>
                </a>               
                <div class="submenu"> 
                    <a href="login.html" class="submenu-item">Login</a>
                    <a href="register.html" class="submenu-item">Register</a>
                </div>
            </nav>
        </aside>

        <!-- Sidebar Overlay (for mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content Area -->
        <main class="main-content">
            <header class="header">
                <div class="d-flex align-items-center">
                    <button class="menu-toggle" id="menuToggle" aria-label="Toggle mobile menu">
                        &#9776;
                    </button>
                    <div>
                        <i class="bi bi-search search-icon"></i>
                    </div>
                </div>
                <div class="user-profile">
                    <img src="assets/img/user/maleavatar.jpg" alt="Avatar">
                    <div class="user-info">
                        <h6>Jon Principal</h6>
                        <span>School Admin</span>
                    </div>
                </div>
            </header>

            <section class="dashboard-filters">
                <div class="filter-group">
                    <label for="academicYearFilter">Academic Year</label>
                    <select id="academicYearFilter">
                        <option value="2024-2025">2024-2025</option>
                        <option value="2023-2024">2023-2024</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="semesterFilter">Term / Semester</label>
                    <select id="semesterFilter">
                        <option value="Fall">Fall</option>
                        <option value="Spring">Spring</option>
                        <option value="FullYear">Full Year</option>
                    </select>
                </div>
                 <div class="filter-group">
                    <label for="expenseStatusFilter">Payment Status</label>
                    <select id="expenseStatusFilter">
                        <option value="All">All</option>
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Overdue">Overdue</option>
                    </select>
                </div>
                 <div class="filter-group">
                    <label for="vendorSearch">Search Vendor/Item</label>
                    <input type="text" id="vendorSearch" class="form-control" placeholder="Vendor Name or Item...">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="addNewExpenseBtn">Add New Expense</button>
                    <button class="btn btn-outline-secondary" id="generateReportBtn">Generate Report</button>
                </div>
            </section>

            <section class="overview-section">
                <div class="card-title">
                    Expenses Overview
                    <div class="filter-display">
                        <span id="overviewFilterText">2024-2025 / Fall</span> <span class="dropdown-arrow">▼</span>
                    </div>
                </div>
                <div class="row g-3 overview-cards expenses-overview-cards">
                    <div class="col-lg-3 col-md-6">
                        <div class="overview-card-item expenses-total-spent">
                            <div class="value" id="totalSpentValue">₹80,000</div>
                            <div class="label">Total Spent</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="overview-card-item expenses-budget-remaining">
                            <div class="value" id="budgetRemainingValue">₹20,000</div>
                            <div class="label">Budget Remaining</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="overview-card-item expenses-pending-payments">
                            <div class="value" id="pendingPaymentsValue">8</div>
                            <div class="label">Pending Payments</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="overview-card-item expenses-overdue-bills">
                            <div class="value" id="overdueBillsValue">3</div>
                            <div class="label">Overdue Bills</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="expenses-list-section mt-4">
                <div class="card expenses-list-table">
                    <div class="card-title">
                        Expense Transactions
                        <div class="filter-display">
                             <span id="expensesListFilterText">All Statuses</span> <span class="dropdown-arrow">▼</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">ITEM/SERVICE</th>
                                    <th scope="col">CATEGORY</th>
                                    <th scope="col">PAID TO</th>
                                    <th scope="col">AMOUNT</th>
                                    <th scope="col">PAYMENT DATE</th>
                                    <th scope="col">STATUS</th>
                                    <th scope="col">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <!-- Data will be dynamically generated -->
                                <tr>
                                    <td>Office Supplies</td>
                                    <td>Administration</td>
                                    <td>Stationery Mart</td>
                                    <td>₹1,200</td>
                                    <td>Oct 12, 2024</td>
                                    <td><span class="badge expenses-status-paid">Paid</span></td>
                                    <td>
                                        <button class="btn btn-outline-secondary btn-sm">View</button>
                                        <button class="btn btn-outline-info btn-sm">Receipt</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Electricity Bill</td>
                                    <td>Utilities</td>
                                    <td>Power Co.</td>
                                    <td>₹8,500</td>
                                    <td>Nov 20, 2024</td>
                                    <td><span class="badge expenses-status-pending">Pending</span></td>
                                    <td>
                                        <button class="btn btn-outline-secondary btn-sm">View</button>
                                        <button class="btn btn-outline-primary btn-sm">Pay Now</button>
                                    </td>
                                </tr>
                                 <tr>
                                    <td>Internet Service</td>
                                    <td>Utilities</td>
                                    <td>ISP Ltd.</td>
                                    <td>₹2,500</td>
                                    <td>Sep 05, 2024</td>
                                    <td><span class="badge expenses-status-overdue">Overdue</span></td>
                                    <td>
                                        <button class="btn btn-outline-secondary btn-sm">View</button>
                                        <button class="btn btn-outline-danger btn-sm">Remind</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
           

            const academicYearFilter = document.getElementById('academicYearFilter');
            const semesterFilter = document.getElementById('semesterFilter');
            const expenseStatusFilter = document.getElementById('expenseStatusFilter');
            const vendorSearch = document.getElementById('vendorSearch');

            // Elements to update
            const totalSpentValue = document.getElementById('totalSpentValue');
            const budgetRemainingValue = document.getElementById('budgetRemainingValue');
            const pendingPaymentsValue = document.getElementById('pendingPaymentsValue');
            const overdueBillsValue = document.getElementById('overdueBillsValue');
            const expensesTableBody = document.getElementById('expensesTableBody');

            const overviewFilterText = document.getElementById('overviewFilterText');
            const expensesListFilterText = document.getElementById('expensesListFilterText');

            // Helper function for Indian Rupee formatting
            const formatIndianRupees = (amount) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };

            // Simulated Expenses Data
            let expensesData = { // Changed to 'let' to allow modification if needed, though not strictly required for this
                '2024-2025': {
                    'Fall': {
                        overview: { totalSpent: 80000, budgetRemaining: 20000, pendingPayments: 8, overdue: 3 },
                        transactions: [
                            { item: 'Office Supplies', category: 'Administration', paidTo: 'Stationery Mart', amount: 1200, paymentDate: 'Oct 12, 2024', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Receipt'] },
                            { item: 'Electricity Bill', category: 'Utilities', paidTo: 'Power Co.', amount: 8500, paymentDate: 'Nov 20, 2024', status: 'Pending', statusClass: 'expenses-status-pending', actions: ['View', 'Pay Now'] },
                            { item: 'Internet Service', category: 'Utilities', paidTo: 'ISP Ltd.', amount: 2500, paymentDate: 'Sep 05, 2024', status: 'Overdue', statusClass: 'expenses-status-overdue', actions: ['View', 'Remind'] },
                            { item: 'Teacher Salary', category: 'Payroll', paidTo: 'John Doe', amount: 45000, paymentDate: 'Oct 31, 2024', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Details'] },
                            { item: 'Sports Equipment', category: 'Facilities', paidTo: 'Sports Gear', amount: 5000, paymentDate: 'Nov 10, 2024', status: 'Pending', statusClass: 'expenses-status-pending', actions: ['View', 'Pay Now'] },
                            { item: 'Maintenance', category: 'Facilities', paidTo: 'Handy Services', amount: 3000, paymentDate: 'Oct 01, 2024', status: 'Overdue', statusClass: 'expenses-status-overdue', actions: ['View', 'Remind'] }
                        ]
                    },
                    'Spring': {
                        overview: { totalSpent: 75000, budgetRemaining: 25000, pendingPayments: 5, overdue: 1 },
                        transactions: [
                            { item: 'Textbooks', category: 'Academics', paidTo: 'Book Depot', amount: 15000, paymentDate: 'Feb 15, 2025', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Receipt'] },
                            { item: 'Water Bill', category: 'Utilities', paidTo: 'Water Works', amount: 3000, paymentDate: 'Mar 10, 2025', status: 'Pending', statusClass: 'expenses-status-pending', actions: ['View', 'Pay Now'] }
                        ]
                    },
                    'FullYear': {
                        overview: { totalSpent: 155000, budgetRemaining: 45000, pendingPayments: 13, overdue: 4 },
                        transactions: [
                            { item: 'Annual Software License', category: 'IT', paidTo: 'Software Solutions', amount: 20000, paymentDate: 'Jan 01, 2025', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Receipt'] },
                            { item: 'Security Services', category: 'Administration', paidTo: 'Guard Force', amount: 12000, paymentDate: 'Dec 15, 2024', status: 'Pending', statusClass: 'expenses-status-pending', actions: ['View', 'Pay Now'] }
                        ]
                    }
                },
                '2023-2024': {
                    'Fall': {
                        overview: { totalSpent: 70000, budgetRemaining: 15000, pendingPayments: 0, overdue: 0 },
                        transactions: [
                            { item: 'Cleaning Services', category: 'Facilities', paidTo: 'Sparkle Clean', amount: 7000, paymentDate: 'Oct 01, 2023', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Receipt'] }
                        ]
                    },
                    'Spring': {
                        overview: { totalSpent: 68000, budgetRemaining: 12000, pendingPayments: 0, overdue: 0 },
                        transactions: [
                            { item: 'Exam Printing', category: 'Academics', paidTo: 'Print Hub', amount: 4000, paymentDate: 'Mar 15, 2024', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Receipt'] }
                        ]
                    },
                    'FullYear': {
                        overview: { totalSpent: 138000, budgetRemaining: 27000, pendingPayments: 0, overdue: 0 },
                        transactions: [
                             { item: 'Annual Audit', category: 'Administration', paidTo: 'Audit & Co.', amount: 10000, paymentDate: 'Jul 30, 2024', status: 'Paid', statusClass: 'expenses-status-paid', actions: ['View', 'Receipt'] }
                        ]
                    }
                }
            };

            // This variable will hold the *currently filtered* transactions for reporting purposes
            let currentFilteredTransactions = [];


            // Function to apply filters and update all expenses sections
            function applyExpensesFilters() {
                const selectedAcademicYear = academicYearFilter.value;
                const selectedSemester = semesterFilter.value;
                const selectedExpenseStatus = expenseStatusFilter.value;
                const searchVendorQuery = vendorSearch.value.toLowerCase();

                const data = expensesData[selectedAcademicYear][selectedSemester];

                // Update Overview Cards with Rupee symbol and formatting
                totalSpentValue.textContent = formatIndianRupees(data.overview.totalSpent);
                budgetRemainingValue.textContent = formatIndianRupees(data.overview.budgetRemaining);
                pendingPaymentsValue.textContent = data.overview.pendingPayments;
                overdueBillsValue.textContent = data.overview.overdue;

                overviewFilterText.textContent = `${selectedAcademicYear} / ${selectedSemester}`;
                expensesListFilterText.textContent = selectedExpenseStatus === 'All' ? 'All Statuses' : selectedExpenseStatus;

                // Filter transactions and store them in currentFilteredTransactions
                currentFilteredTransactions = data.transactions.filter(transaction => {
                    const statusMatch = selectedExpenseStatus === 'All' || transaction.status === selectedExpenseStatus;
                    const vendorItemMatch = transaction.item.toLowerCase().includes(searchVendorQuery) || transaction.paidTo.toLowerCase().includes(searchVendorQuery);
                    return statusMatch && vendorItemMatch;
                });

                // Update Expense Transactions Table
                expensesTableBody.innerHTML = '';
                if (currentFilteredTransactions.length > 0) {
                    currentFilteredTransactions.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.item}</td>
                            <td>${item.category}</td>
                            <td>${item.paidTo}</td>
                            <td>${formatIndianRupees(item.amount)}</td>
                            <td>${item.paymentDate}</td>
                            <td class="text-center"><span class="badge ${item.statusClass}">${item.status}</span></td>
                            <td class="text-center">
                                ${item.actions.map(action => `<button class="btn btn-outline-${action === 'Pay Now' ? 'primary' : action === 'Remind' ? 'danger' : action === 'Receipt' || action === 'Details' ? 'info' : 'secondary'} btn-sm">${action}</button>`).join(' ')}
                            </td>
                        `;
                        expensesTableBody.appendChild(row);
                    });
                } else {
                     expensesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No expense transactions found for the selected filters.</td></tr>`;
                }
            }

            // Event listeners for global filters
            academicYearFilter.addEventListener('change', applyExpensesFilters);
            semesterFilter.addEventListener('change', applyExpensesFilters);
            expenseStatusFilter.addEventListener('change', applyExpensesFilters);
            vendorSearch.addEventListener('input', applyExpensesFilters);

            // Initial filter application on page load
            applyExpensesFilters();

            // Example for Add New Expense button
            document.getElementById('addNewExpenseBtn').addEventListener('click', () => {
                alert('Add New Expense functionality coming soon!'); // You can route this to a new add_expense.html page if needed
            });

            // NEW: Generate Report (Download Excel CSV)
            document.getElementById('generateReportBtn').addEventListener('click', () => {
                if (currentFilteredTransactions.length === 0) {
                    alert('No data to generate report for the current filters.');
                    return;
                }

                const headers = ["ITEM/SERVICE", "CATEGORY", "PAID TO", "AMOUNT", "PAYMENT DATE", "STATUS"];
                let csvContent = headers.map(h => `"${h}"`).join(',') + '\n'; // Add header row

                currentFilteredTransactions.forEach(transaction => {
                    const row = [
                        `"${transaction.item}"`,
                        `"${transaction.category}"`,
                        `"${transaction.paidTo}"`,
                        `${transaction.amount}`, // Use raw amount for calculation in Excel, display formatting is only visual
                        `"${transaction.paymentDate}"`,
                        `"${transaction.status}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                const year = academicYearFilter.value;
                const term = semesterFilter.value;
                const status = expenseStatusFilter.value;
                link.setAttribute('download', `Expenses_Report_${year}_${term}_${status}.csv`);
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link); // Clean up
                URL.revokeObjectURL(url); // Release the object URL

                alert('Expense report downloaded successfully!');
            });
        });
    </script>
</body>
</html>